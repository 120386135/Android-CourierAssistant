package com.exploit.ysd;

import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.widget.EditText;
import android.widget.TextView;
import android.widget.Toast;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.concurrent.Callable;
import java.util.concurrent.Executor;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;

/**
 * Created by Administrator on 2016/9/20.
 */
public class LoginActivity extends Activity{
    private EditText userNameEdit;
    private EditText passwordEdit;
    @Override
    protected void onCreate(Bundle savedInstanceState){
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_login);
        userNameEdit = (EditText) findViewById(R.id.userName);
        passwordEdit = (EditText) findViewById(R.id.password);
        TextView backBtn = (TextView) findViewById(R.id.login_back);
        backBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                LoginActivity.this.finish();
            }
        });
        TextView loginBtn = (TextView) findViewById(R.id.login);
        loginBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                FindUserInMySql task = new FindUserInMySql(userNameEdit.getText().toString(), passwordEdit.getText().toString());
                ExecutorService service = Executors.newSingleThreadExecutor();
                Future<Boolean> future = service.submit(task);
                try{
                    if (future.get()){
                        Toast.makeText(LoginActivity.this, "登录成功", 0).show();
                        Intent intent = new Intent();
                        intent.putExtra("loginResult", userNameEdit.getText().toString());
                        setResult(RESULT_OK,intent);
                        LoginActivity.this.finish();
                    }else{
                        Toast.makeText(LoginActivity.this, "用户名或密码错误", 0).show();
                    }
                }catch (Exception e){
                    e.printStackTrace();
                }
            }
        });
        TextView register = (TextView) findViewById(R.id.signup);
        register.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Intent intent = new Intent(LoginActivity.this, RegisterActivity.class);
                startActivityForResult(intent, 1);
            }
        });
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent returnData){
        if (resultCode == RESULT_OK && requestCode == 1){
            String userName = returnData.getStringExtra("userName");
            Toast.makeText(LoginActivity.this, userName, 0).show();
            Intent intent = new Intent();
            intent.putExtra("loginResult", userName);
            setResult(RESULT_OK,intent);
            LoginActivity.this.finish();
        }
    }

    @Override
    protected void onPause() {
        super.onPause();
    }
    @Override
    protected void onResume() {
        super.onResume();
    }
    @Override
    protected void onDestroy() {  super.onDestroy();}


    class FindUserInMySql implements Callable<Boolean> {
        String id;
        String password;
        String returnPassword = "";
        FindUserInMySql(String userName, String password){
            this.id = userName;
            this.password = password;
        }
        public Boolean call(){
            try{
                Class.forName("com.mysql.jdbc.Driver");
                String url="jdbc:mysql://119.29.200.140/userdb?useUnicode=true&amp;characterEncoding=UTF-8&amp";    //JDBC的URL?useUnicode=true&characterEncoding=utf8
                Connection conn;
                conn = DriverManager.getConnection(url,"root","taizhou8");
                Statement stmt = conn.createStatement(); //创建Statement对象
                System.out.println("成功连接到数据库！");
                String sql = "select * from user where id=" + "\"" + id + "\"";    //要执行的SQL
                ResultSet rs = stmt.executeQuery(sql);//创建数据对象
                while (rs.next()){
                    returnPassword = rs.getString(2);
                    System.out.println(rs.getString(2));
                }
                rs.close();
                stmt.close();
                conn.close();
            }catch(Exception e){
                e.printStackTrace();
            }
            if (returnPassword.length() > 1){
                return password.equals(returnPassword);
            }else {
                return false;
            }
        }
    }

}

/*

 new Thread(){
                    @Override
                    public void run(){
                        try{
                            Class.forName("com.mysql.jdbc.Driver");
                            String url="jdbc:mysql://119.29.200.140/userData";    //JDBC的URL
                            Connection conn;
                            conn = DriverManager.getConnection(url,"root","taizhou8");
                            Statement stmt = conn.createStatement(); //创建Statement对象
                            System.out.println("成功连接到数据库！");
                            String sql = "select * from numAds";    //要执行的SQL
                            ResultSet rs = stmt.executeQuery(sql);//创建数据对象
                            System.out.println("电话"+"\t"+"地址");
                            while (rs.next()){
                                System.out.println("有输出");
                                System.out.print(rs.getBigDecimal(1) + "\t");
                                System.out.print(rs.getString(2) + "\t");
                                System.out.println();
                            }
                            rs.close();
                            stmt.close();
                            conn.close();
                        }catch(Exception e){
                            e.printStackTrace();
                        }
                    }
                }.start();
 */
